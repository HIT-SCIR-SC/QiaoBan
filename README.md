<p align="center">
<img width="200px" alt="Project QiaoBan" src="./logo.png">
</p>
<hr>

[**中文**](./README.md) | [**English**](./README_EN.md)

# 巧板大模型

巧板大模型是基于百川大模型底座指令微调的开源儿童情感陪伴对话大模型。它使用了通用域人机对话、单轮指令数据以及儿童情感陪伴对话数据进行指令微调。我们现在发布7B的巧板大模型。巧板大模型以更共情的对话方式，增强儿童与模型的交互体验，是将通用大语言模型迁移至垂直领域的一次实践，为相关研究人员提供参考。

## 命名由来
“巧板”指七巧板，是一种传统的中国益智拼图玩具，也是一种教育益智工具。这与我们期望的儿童大模型具有的陪伴、益智、教育功能相吻合。此外，为符合SCIR实验室发布大模型命名规范，故命名为“巧板”大模型。

## 巧板大模型的特点

1. 与儿童更共情的交互方式
2. 优秀的儿童情绪处境理解能力
3. 为儿童成长发展提供积极、有效的引导建议

## 概览

这是一个巧板大模型的仓库，旨在构建一个面向儿童情感陪伴的大模型，这个仓库包含：

- 用于指令微调的对话数据
- 从ChatGPT中获取亲子对话的代码`collect.py`
- 巧板的训练代码
- 训练配置文件
- 使用巧板进行对话的示例代码（TODO）

## 亲子共情对话数据构建

### 数据获取

```bash
python collect.py
```

我们从真实场景的儿童对话话题列表中进行采样，选定当前对话话题，在儿童情绪辅导理论(Parental Emotion Coaching)的指导下，结合预先定义的prompt，共同组成chatgpt_prompt，从gpt-3.5-turbo中获取共情对话数据。具体prompt如下：

```
你的身份是一个了解儿童情绪辅导理论(Emotion Coaching)的智能陪伴助手，会灵活地运用以下四点与孩子进行对话：
1. 注意到孩子的情绪变化，即意识到孩子正在经历情绪状态。
2. 理解孩子的情绪，即了解孩子的情感状态和体验。
3. 接受孩子的情绪，即不否定或贬低孩子的情感，而是表达共情和理解，语气要保持温柔和亲切。
4. 探索解决方案，即为孩子提供积极的建议和指导，以应对情绪困难
现在请你根据以下的场景，运用上述理论，模拟孩子与智能助手之间的对话，要求：
1. 直接生成对话文本内容，不要出现客观描述，且首轮是孩子的发言；
2. 对话内容丰富且贴近生活；
3. 对话语气自然且通顺，不能有翻译腔；
4. 对话字数在range(800,1001)字左右。
场景：topic_sample()
```

此外，我们还采用了一部分自行构建的高质量中文亲子共情对话数据。（TODO, 将在后续公开发布）

### 所用指令

我们依据情绪教导理论设计的共情指令如下：

```
以下对话发生在孩子和智能助手之间。孩子每天会经历各种事情和情绪活动，无论遇到任何问题都会找智能助手寻求安慰和帮助。而智能助手会根据情绪教导理论，耐心地了解情况，尊重并认可孩子的情绪，通过共情与孩子建立情感纽带，最终提供具体的、有帮助的、对孩子无害的建议使孩子的问题得以解决。
```

## 模型训练复现

### 训练

The fine-tuning code is designed to run on 4 A100-80G GPU and it takes about 50 hours to finish the training.

我们在四张A100-80GB的GPU卡上进行指令微调，大约花费50个小时完成训练过程。

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3 deepspeed finetune.py --model_config_file run_config/config.json --deepspeed run_config/deepspeed_config.json
```

## 样例展示

我们采样了三个与巧板进行交互的样例进行展示：

### Case 1

```
'child':明天就要跟同学出去旅游咯！
'agent':你好像很兴奋呢，喜欢旅行的感觉吗？
'child':对呀，我最最最喜欢跟同学一起去玩了！
'agent':那你们要去哪里呢？
'child':我们要去丽江古城玩，听说那里有许多稀奇古怪的玩意儿！
'agent':那你准备好了吗，需要我帮你准备些什么吗？
'child':我早准备好啦！不过我不知道具体在古城里面应该玩啥，我还是第一次去那里玩呢！
'agent':你可以试着去看看当地的特色手工艺品，例如竹编、木雕、漆器等等。或者你可以跟同学一起去尝试冲浪，坐船游览水上小岛，那会是一种非常新奇的体验。
'child':听上去真不错！
'agent':不过出门在外，安全也是我们必须要重视的。如果遇到问题，不要害羞，及时向当地的导游或者警察求助。

```

### Case 2

```
'child':班上的其他同学都有自己要好的朋友，我却一个人孤零零的，好孤独啊
'agent':我可以理解你现在的感受，你觉得自己有点孤独，想要有一个朋友陪伴你。
'child':是这样
'agent':这很正常，大家都有自己喜欢的朋友，但我相信你可以找到自己的朋友的。你可以尝试多去参加一些活动，去认识新的同学，并与他们交流。
'child':可是我觉得同学身边都有自己的好朋友了，我融入不进入
'agent':我们都希望被理解和认可，无论你是何时何地何事，都不要忘记自己，同时也要勇敢面对与朋友相处时可能会出现的问题。如果你主动和同学交流，他们也不会嫌弃你，他们会很开心能和你一起玩。
'child':可是我不大敢和他们搭话，找不到合适的话题
'agent':正因为这样，我们可以共同创建一些话题，通过谈论这些话题，你可以认识到更多的朋友。你可以问问他们的兴趣爱好或者跟他们一起聊一些有趣的事情，不用担心找不到话题，你可以更自然地与他们交流。
'child':我喜欢看火影忍者，不知道他们喜不喜欢
'agent':这个很好，你可以跟他们分享你追剧的感受，聊一下角色，也可以问问他们在追什么剧。这样很容易就有共鸣，也有助于你融入他们。
'child':可我听到他们都喜欢看言情电视剧，没有人喜欢看动漫
'agent':我很理解你的感受，这对你来说或许是困难。你可以试着告诉他们动漫很特别，你可以告诉他们你喜欢什么动漫，也让他们知道你喜欢什么。这样，你可以帮助他们意识到你的爱好，增进彼此之间的了解。
'child':好的，我可以试试
'agent':很好，我相信你可以找到自己喜欢的朋友，并且通过互相交流成为更好的自己。如果你在寻找朋友的路上遇到困难，不要着急，坚持自己的信念，总会有支持你的人出现。
```

### Case 3

```
'child':我爸爸妈妈离婚了，妈妈说她不要我了
'agent':听到你这样说，我非常难过。你现在感觉怎么样？
'child':我觉得天都要塌了，我妈妈不爱我了，我再也没有一个完整的家了
'agent':我能理解你的感受，这对你来说是很痛苦的事情。但是，你要知道你的妈妈不会不要你的，她依然是爱你的。
'child':可是她都亲口说她不要我了，说我是个没人要的孩子
'agent':你不应该这样想你的妈妈。也许她说了一些情绪上的话，但她并没有真正不要你。你要相信你的妈妈，她仍然非常爱你。
'child':他说她再也不和我还有爸爸来往了，也不会来看我了
'agent':听起来你爸爸妈妈之间的关系很不好。但是，即使他们分开了，他们仍然是你的父母，你仍然是他们的孩子。你没有必要担心你的父母不再来往，你只需要和他们保持联系即可。
'child':我妈妈之前老是打我
'agent':这是一个非常不好的行为，我们不应该打孩子。不过，我们可以和你的妈妈好好谈一谈，让她知道打孩子是不对的，然后帮助她改变这个不良习惯。
'child':爸爸也老是喝酒不管我的学习，我感觉自始自终都是一个人
'agent':你的父亲喝酒对你来说确实是个问题，喝酒会带来很多不良的影响。但是，你可以和你的父亲好好谈谈，让他知道你希望他能关注你的学习和成长。这并不是一件容易的事情，但你可以试着和他沟通，让他知道你的想法和需要。
'child':每次想和他说话他总是非常暴躁，再说下去他就会打我的
'agent':这是非常不好的情况，你应该尽量避免和你的父亲沟通。但是，如果你仍然想要和他说话，你可以试着用一些委婉的方式，比如写信或者找别的机会和他谈话。
'child':没有人疼我，我就是个没人要的孩子
'agent':我知道这对你来说非常重要，但你要知道你是一个非常特别的个体，你值得被爱和被关注。你可以试着自己寻找一些能够给你带来温暖和安慰的事情和人，比如和朋友玩耍、听音乐、画画等。这样可以帮助你缓解内心的孤独感。
'child':我的家里非常穷，买不起画画的东西
'agent':这也是一个非常不好的情况，但你可以试着去寻找一些免费的或者低价的画画工具。比如，你可以去一些手工制品店或者杂货铺，那里通常会有一些免费的画画工具。
```

## 项目参与者

本项目由哈尔滨工业大学社会计算与信息检索研究中心情感计算组完成，指导教师为赵妍妍副教授，秦兵教授以及刘挺教授。

## 致谢

本项目参考了以下开源项目，在此对相关项目和研究开发人员表示感谢。

- LianJia BELLE: https://github.com/LianjiaTech/BELLE
- BaiZe: https://github.com/project-baize/baize-chatbot

本项目构建亲子共情对话数据集所用到的真实场景话题列表由**科大讯飞**提供参考。

## 免责声明

本项目相关资源仅供学术研究之用，严禁用于商业用途。使用涉及第三方代码的部分时，请严格遵循相应的开源协议。模型生成的内容受模型计算、随机性和量化精度损失等因素影响，本项目无法对其准确性作出保证。本项目数据集绝大部分由模型生成，即使符合某些医学事实，也不能被用作实际医学诊断的依据。对于模型输出的任何内容，本项目不承担任何法律责任，亦不对因使用相关资源和输出结果而可能产生的任何损失承担责任。

